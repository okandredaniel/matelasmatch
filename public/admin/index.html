<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Content Manager</title>
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>
  </head>
  <body>
    <div id="nc-root"></div>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="https://unpkg.com/decap-cms@^3/dist/decap-cms.js"></script>
    <script>
      const L = (...a) => console.log('[admin]', ...a);
      const E = (...a) => console.error('[admin]', ...a);

      async function loadYml(url) {
        L('fetch', url);
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) {
          E('fetch-failed', url, r.status);
          throw new Error(url);
        }
        const t = await r.text();
        L('fetched', url, t.length);
        const y = jsyaml.load(t);
        L('parsed', url);
        return y;
      }

      async function saveGithubUserToken(token) {
        L('token-received');
        try {
          const resp = await fetch('https://api.github.com/user', {
            headers: {
              Authorization: `token ${token}`,
              Accept: 'application/vnd.github+json',
            },
          });
          const profile = await resp.json();
          const payload = {
            token,
            user: {
              login: profile.login,
              name: profile.name,
              avatar_url: profile.avatar_url,
            },
            provider: 'github',
          };
          localStorage.setItem('decap-cms-user', JSON.stringify(payload));
          localStorage.setItem('netlify-cms-user', JSON.stringify(payload));
          L('token-stored', { login: profile.login });
        } catch (err) {
          E('save-token-error', String(err));
          localStorage.setItem('decap-cms-user', JSON.stringify({ token }));
          localStorage.setItem('netlify-cms-user', JSON.stringify({ token }));
        }
      }

      function readStoredUser() {
        try {
          const a = localStorage.getItem('decap-cms-user');
          const b = localStorage.getItem('netlify-cms-user');
          const ua = a ? JSON.parse(a) : null;
          const ub = b ? JSON.parse(b) : null;
          L('stored-user', {
            decap: !!ua?.token,
            netlify: !!ub?.token,
            login: ua?.user?.login || ub?.user?.login || null,
          });
        } catch (e) {
          E('read-stored-user-error', String(e));
        }
      }

      window.addEventListener(
        'message',
        async (e) => {
          if (typeof e.data !== 'string') return;
          const okPrefix = 'authorization:github:success:';
          const errPrefix = 'authorization:github:error:';
          L('postMessage', e.origin, e.data.slice(0, 80));
          try {
            if (e.data.startsWith(okPrefix)) {
              const { token } = JSON.parse(
                e.data.slice(okPrefix.length) || '{}'
              );
              if (!token) return E('missing-token');
              await saveGithubUserToken(token);
              location.reload();
            } else if (e.data.startsWith(errPrefix)) {
              const payload = JSON.parse(
                e.data.slice(errPrefix.length) || '{}'
              );
              E('oauth-error', payload);
            }
          } catch (err) {
            E('msg-handler-error', String(err));
          }
        },
        false
      );

      function waitForCMS() {
        return new Promise((resolve, reject) => {
          if (window.CMS) return resolve(window.CMS);
          const t0 = Date.now();
          const i = setInterval(() => {
            if (window.CMS) {
              clearInterval(i);
              resolve(window.CMS);
            } else if (Date.now() - t0 > 7000) {
              clearInterval(i);
              reject(new Error('CMS not loaded'));
            }
          }, 50);
        });
      }

      window.addEventListener('load', async () => {
        L('page-load', location.href);
        readStoredUser();
        try {
          const isDev = location.hostname === 'localhost';
          const baseUrl = isDev
            ? '/decap/base.dev.yml'
            : '/decap/base.prod.yml';
          const [base, brands, mattresses] = await Promise.all([
            loadYml(baseUrl),
            loadYml('/decap/collections/brands.yml'),
            loadYml('/decap/collections/mattresses.yml'),
          ]);
          const collections = [
            ...(brands.collections || []),
            ...(mattresses.collections || []),
          ];
          L('init-cms', {
            isDev,
            baseUrl,
            collections: collections.map((c) => c.name),
          });
          await waitForCMS();
          CMS.init({
            load_config_file: false,
            config: { ...base, collections },
          });
          L('cms-initialized');
        } catch (err) {
          E('init-error', String(err));
        }
      });
    </script>
  </body>
</html>
